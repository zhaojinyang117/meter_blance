name: 电表余额监控网站部署

on:
  # 在电表余额查询工作流完成后运行
  workflow_run:
    workflows: ["电表余额查询"]
    types:
      - completed
  # 允许手动触发
  workflow_dispatch:

jobs:
  deploy-to-cloudflare:
    runs-on: ubuntu-latest
    # 只有当触发的工作流成功完成时才运行
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: 电表  # 使用与电表余额查询相同的环境
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 下载电表余额日志
      if: ${{ github.event_name == 'workflow_run' }}
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: ${{ github.event.workflow_run.id }}
          });
          
          const matchArtifact = artifacts.data.artifacts.find(artifact => {
            return artifact.name == "logs"
          });
          
          if (!matchArtifact) {
            core.setFailed('未找到日志文件');
            return;
          }
          
          const download = await github.rest.actions.downloadArtifact({
            owner: context.repo.owner,
            repo: context.repo.repo,
            artifact_id: matchArtifact.id,
            archive_format: 'zip'
          });
          
          const fs = require('fs');
          fs.writeFileSync('logs.zip', Buffer.from(download.data));
          
    - name: 解压日志文件
      if: ${{ github.event_name == 'workflow_run' }}
      run: unzip -o logs.zip
      
    - name: 提取电表余额
      if: ${{ github.event_name == 'workflow_run' }}
      id: extract_balance
      run: |
        if [ -f "meter_balance.log" ]; then
          # 从日志中提取最新的电表余额（使用特殊格式标记）
          BALANCE=$(grep "===METER_BALANCE_RESULT===" meter_balance.log | tail -1 | grep -o "电表余额: [0-9.]*度" | grep -o "[0-9.]*")
          if [ -n "$BALANCE" ]; then
            echo "balance=$BALANCE" >> $GITHUB_OUTPUT
            echo "成功提取电表余额: $BALANCE"
          else
            echo "未能从日志中提取电表余额"
            exit 1
          fi
        else
          echo "日志文件不存在"
          exit 1
        fi
        
    - name: 手动设置测试余额（仅用于手动触发）
      if: ${{ github.event_name == 'workflow_dispatch' }}
      id: manual_balance
      run: |
        # 这里设置一个测试值，仅用于手动触发时测试部署
        echo "balance=285.78" >> $GITHUB_OUTPUT
        echo "使用测试电表余额: 285.78"
        
    - name: 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: 更新电表数据
      run: |
        if [ "${{ github.event_name }}" == "workflow_run" ]; then
          python update_meter_data.py ${{ steps.extract_balance.outputs.balance }}
        else
          python update_meter_data.py ${{ steps.manual_balance.outputs.balance }}
        fi
        
    - name: 设置Node.js环境
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: 安装Wrangler CLI
      run: npm install -g wrangler
      
    - name: 验证Cloudflare凭据
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        echo "验证Cloudflare账号ID和API令牌..."
        echo "账号ID长度: ${#CLOUDFLARE_ACCOUNT_ID}"
        echo "API令牌长度: ${#CLOUDFLARE_API_TOKEN}"
        
        # 检查环境变量是否设置
        if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
          echo "错误: CLOUDFLARE_API_TOKEN 未设置"
          exit 1
        fi
        
        if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
          echo "错误: CLOUDFLARE_ACCOUNT_ID 未设置"
          exit 1
        fi
        
        # 验证API令牌
        echo "尝试验证API令牌..."
        curl -s -X GET "https://api.cloudflare.com/client/v4/user/tokens/verify" \
          -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
          -H "Content-Type: application/json" | grep -q "\"success\":true"
        
        if [ $? -eq 0 ]; then
          echo "API令牌验证成功"
        else
          echo "API令牌验证失败，请检查令牌是否有效且具有足够的权限"
          exit 1
        fi

    - name: 部署到Cloudflare Pages
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        # 创建部署目录
        mkdir -p dist
        
        # 复制网站文件到部署目录
        cp index.html dist/
        cp styles.css dist/
        cp script.js dist/
        cp data.json dist/
        
        # 直接使用Wrangler部署（自动创建项目）
        echo "使用Wrangler部署到Cloudflare Pages..."
        echo "使用的账号ID: $CLOUDFLARE_ACCOUNT_ID"
        
        # 使用--project-name参数部署
        # 添加--commit-dirty=true参数忽略未提交的更改警告
        # 首先尝试创建项目
        echo "尝试创建项目..."
        wrangler pages project create meter-balance-monitor || true
        
        # 然后部署
        echo "部署项目..."
        wrangler pages deploy dist --project-name=meter-balance-monitor --commit-dirty=true